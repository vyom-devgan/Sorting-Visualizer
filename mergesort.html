<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
    <svg id="chart-svg" width="800" height="600"></svg>
    <button id="sort">Sort</button>
    <script>
        var data = [];
        var svg = d3.select("#chart-svg"),
            width = +svg.attr("width"),
            height = +svg.attr("height");

        var xScale = d3.scaleBand().range([0, width]).padding(0.1);
        var yScale = d3.scaleLinear().range([height, 0]);

        function renderBars(data) {
            xScale.domain(data.map((d, i) => i));
            yScale.domain([0, d3.max(data, function (d) { return d.value; })]);

            var bars = svg.selectAll(".bar").data(data, function (d) { return d.value; });

            bars.enter()
                .append("rect")
                .attr("class", "bar")
                .merge(bars)
                .attr("x", function (d, i) { return xScale(i); })
                .attr("y", function (d) { return yScale(d.value); })
                .attr("width", xScale.bandwidth())
                .attr("height", function (d) { return height - yScale(d.value); })
                .attr("fill", function (d) {
                    return d.beingSorted ? "orange" : (d.sorted ? "green" : "steelblue");
                });

            bars.exit().remove();
        }

        svg.on("click", function (event) {
            var coords = d3.pointer(event, svg.node());
            var newValue = yScale.invert(coords[1]);
            data.push({ value: newValue });
            renderBars(data);
        });

        async function mergeSortStepByStep(arr) {
            for (var i = 0; i < arr.length; i++) {
                var minIndex = i;
                for (var j = i + 1; j < arr.length; j++) {
                    if (arr[j].value < arr[minIndex].value) {
                        minIndex = j;
                    }
                }
                await swap(arr, i, minIndex);
                renderBars(arr);
            }
        }

        async function swap(arr, i, j) {
            arr[i].beingSorted = true;
            arr[j].beingSorted = true;
            await sleep(1000); // Adjust the delay as needed
            var temp = arr[i];
            arr[i] = arr[j];
            arr[j] = temp;
            arr[i].sorted = true;
            arr[j].sorted = true;
            arr[i].beingSorted = false;
            arr[j].beingSorted = false;
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        document.getElementById("sort").addEventListener("click", async function () {
            await mergeSortStepByStep(data);

            // Check if all bars are sorted
            var allSorted = data.every(function (d) {
                return d.sorted;
            });

            if (allSorted) {
                // Change the color of all bars to blue
                data.forEach(function (d) {
                    d.beingSorted = false;
                });
                renderBars(data);
            }
        });
    </script>
</body>
</html>
